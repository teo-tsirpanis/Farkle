<Project Sdk="Microsoft.NET.Sdk">
  <Import Project="../Farkle.Tools.Shared/Farkle.Tools.Shared.proj" />
  <PropertyGroup>
    <TargetFrameworks>net45;netcoreapp2.1</TargetFrameworks>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <NuspecFile>Farkle.Tools.MSBuild.nuspec</NuspecFile>
    <!-- Isn't that supposed to be automatiaclly included?? -->
    <Version Condition="'$(Version)' == ''">1.0.0</Version>
    <!-- Because this repository does not use Paket, it does not play well with
    the others that do, and raises package downgrade warnings. To be removed when
    this project gets fixed, or the others abandon Paket. -->
    <NuspecProperties>version=$(Version)</NuspecProperties>
    <GenerateNuspecDependsOn>PreparePack;$(GenerateNuspecDependsOn)</GenerateNuspecDependsOn>
  </PropertyGroup>
  <ItemGroup>
    <EmbeddedResource Include="../Farkle.Tools/builtin-templates/Grammar.*.scriban" />
    <Compile Include="FarkleCreateTemplateTask.fs" />
    <None Include="Farkle.Tools.MSBuild.props" />
    <None Include="Farkle.Tools.MSBuild.targets" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="Scriban" Version="2.*" />
    <PackageReference Update="FSharp.Core" Version="4.7.*" />
    <PackageReference Update="System.ValueTuple" Version="4.5.*" />
    <PackageReference Include="Serilog.Sinks.MSBuild" Version="1.*" />
    <ProjectReference Include="..\Farkle\Farkle.fsproj" />
  </ItemGroup>

  <Target Name="PreparePack" BeforeTargets="GenerateNuspec" DependsOnTargets="Build">
    <ItemGroup>
      <_FrameworksToBuild Include="$(TargetFrameworks)" />
      <_ProjectsToPublish
              Include="$(MSBuildThisFileFullPath)"
              AdditionalProperties="TargetFramework=%(_FrameworksToBuild.Identity);PublishDir=tools\%(_FrameworksToBuild.Identity)\" />
    </ItemGroup>
    <RemoveDir Directories="tools/" />
    <MSBuild Projects="@(_ProjectsToPublish)" Properties="NoBuild=true;Configuration=$(Configuration)" Targets="Publish" BuildInParallel="$(BuildInParallel)" />
  </Target>
  <Target Name="AfterPack" AfterTargets="Pack">
    <RemoveDir Directories="tools/" />
  </Target>
</Project>
