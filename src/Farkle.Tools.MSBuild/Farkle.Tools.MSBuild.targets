<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Farkle.Tools.MSBuild.FarkleCreateTemplateTask" AssemblyFile="$(FarkleTaskAssembly)"/>
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    <BuildDependsOn>GenerateFarkleTemplates;$(BuildDependsOn)</BuildDependsOn>
    <CleanDependsOn>$(CleanDependsOn);CleanFarkleGeneratedTemplates</CleanDependsOn>
    <_FarkleOutputExtension Condition="'$(Language)' == 'C#'">.g.cs</_FarkleOutputExtension>
    <_FarkleOutputExtension Condition="'$(Language)' == 'F#'">.g.fs</_FarkleOutputExtension>
  </PropertyGroup>
  <Target
          Name="GenerateFarkleTemplates"
          Inputs="@(Farkle)"
          Outputs="%(Farkle.RootDir)%(Farkle.Directory)%(Farkle.OutputDirectorySuffix)%(Farkle.FileName)$(_FarkleOutputExtension)"
          Condition="'@(Farkle)' != ''">

    <PropertyGroup>
      <_Output>%(Farkle.RootDir)%(Farkle.Directory)%(Farkle.OutputDirectorySuffix)%(Farkle.FileName)$(_FarkleOutputExtension)</_Output>
      <_Namespace>%(Farkle.Namespace)</_Namespace>
      <_Namespace Condition="'$(_Namespace)' == ''">$(RootNamespace)</_Namespace>
    </PropertyGroup>

    <Error
            Condition="'$(Language)' == 'VB'" File="%(Farkle.FullPath)"
            Text="Visual Basic is a language with poor performance characteristics, and is not natively supported by Farkle."/>
    <Error
            Condition="'$(Language)' != 'C#' AND '$(Language)' != 'F#'" File="%(Farkle.FullPath)"
            Text="The language $(Language) is not natively supported by Farkle."/>

    <FarkleCreateTemplateTask
            Grammar="%(Farkle.FullPath)"
            Language="$(Language)"
            Namespace="$(_Namespace)"
            OutputFile="$(_Output)"/>

    <ItemGroup Condition="'$(Language)' == 'C#'">
      <!-- We have to ensure that the generated file is being included in the Compile item
      only once. It might have been already included in cases like a rebuild (the file existed,
      had been caught by the wildcard, deleted by the target below, generated again, but had
      never been removed from Compile). Removing it from Compile at the cleaning target did not
      work either. We also use the absolute path below, which is fine, because MSBuild removes the
      item even if it had been imported as a relative path. And it has been tested that removing
      a non-existent item does not cause a problem. -->
      <Compile Remove="$(_Output)" />
      <Compile Include="$(_Output)" />
    </ItemGroup>
  </Target>
  <Target Name="CleanFarkleGeneratedTemplates" BeforeTargets="Clean">
    <Delete Files="@(Farkle->'%(RootDir)%(Directory)%(OutputDirectorySuffix)%(FileName)$(_FarkleOutputExtension)')"/>
  </Target> 
</Project>
