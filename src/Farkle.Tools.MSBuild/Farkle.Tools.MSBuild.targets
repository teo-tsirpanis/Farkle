<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Farkle.Tools.MSBuild.FarkleCreateTemplateTask" AssemblyFile="$(FarkleTaskAssembly)"/>
  <PropertyGroup>
    <BuildDependsOn>GenerateFarkleTemplates;$(BuildDependsOn)</BuildDependsOn>
    <CleanDependsOn>$(CleanDependsOn);CleanFarkleGeneratedTemplates</CleanDependsOn>
  </PropertyGroup>
  <Target
          Name="GenerateFarkleTemplates"
          Inputs="@(Farkle)"
          Outputs="@(Farkle->'%(RootDir)%(Directory)%(FileName)%(OutputExtension)')"
          Condition="'@(Farkle)' != ''">

    <PropertyGroup>
      <_Template>$(FarkleTemplateOverride)</_Template>
      <_Template Condition="'$(_Template)' == ''">%(Farkle.Template)</_Template>
      <_Output>%(Farkle.RootDir)%(Farkle.Directory)%(Farkle.FileName)%(Farkle.OutputExtension)</_Output>
      <_Namespace>%(Farkle.Namespace)</_Namespace>
      <_Namespace Condition="'$(_Namespace)' == ''">$(RootNamespace)</_Namespace>
    </PropertyGroup>

    <Error
            Condition="'$(Language)' == 'VB' AND '$(_Template)' == ''" File="%(Farkle.FullPath)"
            Text="Visual Basic is a language with poor performance characteristics, and is not natively supported by Farkle. Please specify your own template."/>
    <Error
            Condition="'$(Language)' != 'C#' AND '$(Language)' != 'F#' AND '$(_Template)' == ''" File="%(Farkle.FullPath)"
            Text="The language $(Language) is not natively supported by Farkle. Please specify your own template."/>

    <FarkleCreateTemplateTask
            Grammar="%(Farkle.FullPath)"
            Language="$(Language)"
            CustomTemplate="$(_Template)"
            Namespace="$(_Namespace)"
            OutputFile="$(_Output)"/>
  </Target>
  <Target Name="CleanFarkleGeneratedTemplates" BeforeTargets="Clean">
    <Delete Files="@(Farkle->'%(RootDir)%(Directory)%(FileName)%(OutputExtension)')"/>
  </Target> 
</Project>
