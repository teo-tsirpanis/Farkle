<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <FarkleSuppressGrammarErrors Condition="'$(FarkleSuppressGrammarErrors)' == ''">false</FarkleSuppressGrammarErrors>
  </PropertyGroup>

  <UsingTask
      Condition="$(FarkleEnablePrecompiler) != false AND $(MSBuildRuntimeType) == Core"
      TaskName="Farkle.Tools.MSBuild.FarklePrecompileInProcess"
      AssemblyFile="$(FarkleTaskAssembly)"/>

  <UsingTask
      Condition="$(FarkleEnablePrecompiler) != false AND $(MSBuildRuntimeType) != Core"
      TaskName="Farkle.Tools.MSBuild.FarklePrecompileIpc"
      AssemblyFile="$(FarkleTaskAssembly)"/>

  <UsingTask
      Condition="$(FarkleEnablePrecompiler) != false AND $(FarkleGenerateHtml) == true"
      TaskName="Farkle.Tools.MSBuild.FarkleGenerateHtml"
      AssemblyFile="$(FarkleTaskAssembly)"/>

  <!--TODO: Find better error messages.-->
  <Target
      Name="FailPrecompilerOnNetFramework"
      Condition="false AND $(MSBuildRuntimeType) != Core"
      BeforeTargets="FarklePrecompileGrammars">
    <PropertyGroup>
      <_CommonPrecompilerErrorExplanation>You have to use commands from the .NET SDK, like "dotnet build". See more in https://teo-tsirpanis.github.io/Farkle/the-precompiler.html#Building-from-an-IDE</_CommonPrecompilerErrorExplanation>
    </PropertyGroup>
    <Error
        Condition="$(BuildingInsideVisualStudio) == true"
        Text="Farkle's precompiler does not currently support running in Visual Studio. $(_CommonPrecompilerErrorExplanation)"/>
    <Error
        Condition="$(MSBuildRuntimeType) == Mono"
        Text="Farkle's precompiler does not support running in Mono. $(_CommonPrecompilerErrorExplanation)"/>
    <Error
        Text="Farkle's precompiler is not supported in .NET Framework editions of MSBuild. $(_CommonPrecompilerErrorExplanation)"/>
  </Target>

  <Target
      Name="FarkleRunPrecompiler"
      Condition="$(FarkleEnablePrecompiler) != false"
      DependsOnTargets="CheckForMSBuild16">
    <FarklePrecompileInProcess
        Condition="$(MSBuildRuntimeType) == Core"
        AssemblyPath="@(IntermediateAssembly->'%(FullPath)')"
        Configuration="@(SigourneyConfiguration)"/>

    <FarklePrecompileIpc
        Condition="$(MSBuildRuntimeType) != Core"
        AssemblyPath="@(IntermediateAssembly->'%(FullPath)')"
        Configuration="@(SigourneyConfiguration)"
        CustomWorkerPath="$(FarkleCustomPrecompilerWorkerPath)"/>
  </Target>

  <Target
    Name="FarkleCreateHTML"
    Condition="$(FarkleGenerateHtml) == true"
    AfterTargets="FarkleRunPrecompiler">
    <FarkleGenerateHtml
      AssemblyPath="@(IntermediateAssembly->'%(FullPath)')"
      OutputDirectory="$(OutputPath)">
      <Output TaskParameter="GeneratedFiles" ItemName="FileWrites"/>
    </FarkleGenerateHtml>
  </Target>
</Project>
